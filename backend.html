<!doctype html>
<html>

<head>

    <style>
    .user {
        border: 1px solid black;
        float: left;
        margin: 5px;
        padding: 5px;
        word-wrap: break-word;
        display: none;
    }
    </style>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">

</head>

<body>

    There are
    <span id="TotalUsers"></span>
    total users.
    <br>


    <div id="users"></div>
    <div id="charts" class="container"></div>


    <script src="socket.io/socket.io.js"></script>
    <script src="/node_modules/raphael/raphael-min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    $(function() {
        var socket = io();
        var papers = new Object;
        var viewers = new Object;
        socket.on('update info', function(info) {
            counter = 0;
            rownums = 4;
            $('#users').append('<div id=' + info.id + ' class="user"></div>');
            $('#' + info.id).append($('<div>').text(info.hosts));
            $('#' + info.id).append($('<div>').text(info.referrers));


            total = Object.keys(info.creatives).length;

            for (var n in info.creatives) {
                creative = info.creatives[n];
                if (!$('#' + creative.id).length) {
                    console.log(creative.id);
                    if (counter % rownums == 0) $('#charts').append("<div class='row'>");

                    $('.row').last().append('<div id="' + creative.id + '" class="chart col-xs-' + 12 / rownums + '">');
                    if (typeof creative.tag !== "undefined") {
                        papers[creative.id] = Raphael($('#' + creative.id)[0], $('#' + creative.id).width(), $('#' + creative.id).width());
                        width = $('#' + creative.id).width();
                        height = $('#' + creative.id).width();
                        radius = $('#' + creative.id).width() / 2;

                        var rectangle = papers[creative.id].rect(0, 0, width, height);
                        rectangle.attr("fill", "lightGreen");
                        rectangle.attr("stroke", "white");

                    } else {
                        $('#' + creative.id).text('No tag was found for ' + creative.id + '.')
                    }
                    counter++;

                    /*
                $('#'+info.id).append(creative.id+'<div id='+creative.id+' class="visible"></div>');
                $('#'+info.id).append($('<li>').html("Bid: " + creative.pm_bid));
                $('#'+info.id).append($('<li>').html(creative.tag)); 
                */
                }
                if (typeof papers[creative.id] !== "undefined") {
                    viewers[info.id + creative.id] = papers[creative.id].circle(0, height - radius/10, radius / 10);
                    viewers[info.id + creative.id].attr("fill", "red");
                    viewers[info.id + creative.id].attr("stroke", "white");
                    viewers[info.id + creative.id].show();
                }
            }
            if (total % rownums != 0) $('.row').last().find('div').removeClass('col-xs-' + 12 / rownums).addClass('col-xs-' + 12 / (total % rownums));
        });

        socket.on('update backend visible', function(info) {
            for (var n in info.creatives) {
                creative = info.creatives[n];
                width = $('#' + creative.id).width();
                if (typeof viewers[info.id + creative.id] !== "undefined") {
                    if (typeof creative.visible === "number") {
                        if (creative.visible > 0) viewers[info.id + creative.id].show();
                        else viewers[info.id + creative.id].hide();
                        viewers[info.id + creative.id].attr({
                            cx: Math.round((creative.visible * width) - radius/10)
                        });
                    }
                }

                /*
        $('#'+info.id + ' #'+creative.id).text("Visible: " + creative.visible);
        */
            }
        });

        socket.on('userJoined', function(data) {
            console.log('A user joined with id #' + data.id);
            $('#TotalUsers').text(data.total - 1);
        });

        socket.on('user left', function(data) {
            $('#TotalUsers').text(data.susers - 1);
            $('#' + data.suid).remove();
            console.log('A user disconnected with id #' + data.suid);
        });
    });
    </script>


</body>

</html>
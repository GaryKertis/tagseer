function formatChartData(t){var e,a=[],r=[];t.sort();for(var o=0;o<t.length;o++)t[o]!==e?(a.push(t[o]),r.push(1)):r[r.length-1]++,e=t[o];formatted=[a,r],output=[["Site","Users"]];for(var o=0;o<formatted[0].length;o++)output.push([formatted[0][o],formatted[1][o]]);return output}function updateCharts(){sitesChart(formatChartData(sitelist)),browserChart(formatChartData(browserlist))}function drawChart(){chart=new google.visualization.ColumnChart(document.getElementById("chart_div")),piechart=new google.visualization.PieChart(document.getElementById("piechart")),userchart=new google.visualization.AreaChart(document.getElementById("userchart")),updateCharts()}function browserChart(t){var e;e=google.visualization.arrayToDataTable(!t||t.length<2?[["Browser","Users"],["Unknown",0]]:t);var a={title:"Browsers",animation:{duration:500,easing:"out"}};piechart.draw(e,a)}function userChart(t){var e=google.visualization.arrayToDataTable(t),a={title:"User Volume",hAxis:{textPosition:"none"},vAxis:{minValue:0,maxValue:25},animation:{duration:500,easing:"out"}};userchart.draw(e,a)}function sitesChart(t){var e;e=google.visualization.arrayToDataTable(!t||t.length<2?[["Sites","Users"],["Unknown",0]]:t);var a={title:"Sites by User",hAxis:{title:"Site",titleTextStyle:{color:"black"}},animation:{duration:500,easing:"out"},vAxis:{minValue:0,maxValue:25},showValue:!0},r=new google.visualization.DataView(e);r.setColumns([0,1,{calc:"stringify",sourceColumn:1,type:"string",role:"annotation"}]),chart.draw(r,a)}var mapOptions={center:new google.maps.LatLng(39.5,-35),zoom:2},sitelist=[],browserlist=[],userData=new Object,currentConnected=0,connecteduserdata=[["Minute","Users"]],chart,browserchart,userchart,map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),styles=[{featureType:"landscape",stylers:[{saturation:-100},{visibility:"simplified"}]}];map.setOptions({styles:styles}),google.load("visualization","1",{packages:["corechart"]}),google.setOnLoadCallback(drawChart),setInterval(function(){var t=new Date;connecteduserdata.push([t.getTime(),currentConnected]),userChart(connecteduserdata)},5e3),$(function(){var t=0,e=io(document.location.host,{multiplex:!1,path:"/socket.io"}),a=new Object;e.emit("bc"),e.on("uj",function(e){function r(t){var a=30;if("number"==typeof e.creatives.v){if(e.creatives.v>0){var r=t.get("icon");r.fillColor="green",r.strokeColor="green",r.strokeOpacity=e.creatives.v,r.fillOpacity=e.creatives.v}if(e.creatives.v<=0){var r=t.get("icon");r.strokeColor="red",r.fillColor="red",r.fillOpacity=.05}}var o=window.setInterval(function(){a--;var e=t.get("icon");e.strokeWeight=a,t.set("icon",e),1>=a&&clearInterval(o)},15)}t++,$("#Impressions").text(t),currentConnected=e.total||0,$("#TotalUsers").text(currentConnected);var o={icon:{path:google.maps.SymbolPath.CIRCLE,fillOpacity:.05,fillColor:"blue",strokeOpacity:1,strokeColor:"blue",strokeWeight:30,scale:5},map:map,position:new google.maps.LatLng(e.latitude,e.longitude)};a[e.id]=new google.maps.Marker(o),"undefined"!=typeof a[e.id]&&r(a[e.id]),userData[e.id]={site:e.site},sitelist.push(e.site),userData[e.id].browser=e.browser,browserlist.push(e.browser),updateCharts()}),e.on("ul",function(t){function e(t){var e=t.get("icon"),a=30,r=window.setInterval(function(){a--,e.strokeWeight=a,e.strokeColor="#000000",t.set("icon",e),0>=a&&(clearInterval(r),t.setMap(null))},20)}"undefined"==typeof userData[t.suid]&&console.log(t.suid+" didn't register."),$("#TotalUsers").text(t.susers),sitelist.splice(sitelist.indexOf(userData[t.suid].site),1),browserlist.splice(browserlist.indexOf(userData[t.suid].browser),1),updateCharts(),"undefined"!=typeof a[t.suid]&&e(a[t.suid])})});